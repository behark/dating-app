#!/usr/bin/env node

/**
 * Fetch Render environment variables via API
 */

const https = require('https');

const SERVICE_ID = 'srv-d5cooc2li9vc73ct9j70';
const API_KEY = process.env.RENDER_API_KEY;

if (!API_KEY) {
  console.error('Error: RENDER_API_KEY environment variable is required');
  process.exit(1);
}

function makeRequest(path) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.render.com',
      path: path,
      method: 'GET',
      headers: {
        Authorization: `Bearer ${API_KEY}`,
        Accept: 'application/json',
      },
    };

    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          const json = JSON.parse(data);
          resolve({ status: res.statusCode, data: json });
        } catch (e) {
          resolve({ status: res.statusCode, data: data });
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.end();
  });
}

function processEnvironmentVariable(env) {
  let value = '[NOT SET]';

  if (env.value !== undefined && env.value !== null && env.value !== '') {
    value = maskSensitiveValue(env.key, env.value);
  } else if (env.generateValue === true) {
    value = '[AUTO-GENERATED BY RENDER]';
  }

  return { value: env.value, display: value };
}

function maskSensitiveValue(key, rawValue) {
  if (isSensitiveKey(key)) {
    return rawValue.length > 20 ? `${rawValue.substring(0, 20)}...` : '***';
  }

  if (key === 'MONGODB_URL' || key === 'MONGODB_URI') {
    return maskMongoDbUrl(rawValue);
  }

  return rawValue;
}

function isSensitiveKey(key) {
  return (
    key.includes('SECRET') ||
    key.includes('KEY') ||
    key.includes('PASSWORD') ||
    key.includes('TOKEN')
  );
}

function maskMongoDbUrl(url) {
  const match = url.match(/mongodb\+srv:\/\/([^:]+):([^@]+)@/);
  if (match) {
    return `mongodb+srv://${match[1]}:***@${url.split('@')[1]}`;
  }
  return `${url.substring(0, 30)}...`;
}

async function fetchEnvVars() {
  console.log('='.repeat(80));
  console.log('Fetching Render Environment Variables via API');
  console.log('='.repeat(80));
  console.log('');

  try {
    // Try the env-vars endpoint
    console.log('Fetching environment variables...');
    const response = await makeRequest(`/v1/services/${SERVICE_ID}/env-vars`);

    console.log(`Status: ${response.status}`);
    console.log('');

    if (response.status === 200 && response.data) {
      if (Array.isArray(response.data)) {
        console.log(`Found ${response.data.length} environment variables:\n`);
        console.log('-'.repeat(80));

        const envVars = {};
        response.data.forEach((item) => {
          const env = item.envVar || item;
          if (env && env.key) {
            const processedEnv = processEnvironmentVariable(env);
            envVars[env.key] = processedEnv;
            console.log(`${env.key.padEnd(30)} = ${processedEnv.display}`);
          }
        });

        console.log('');
        console.log('-'.repeat(80));
        console.log('');

        // Check critical variables
        console.log('üìã CRITICAL VARIABLES STATUS:');
        console.log('-'.repeat(80));

        const critical = {
          MONGODB_URI: 'Required - MongoDB connection string',
          JWT_SECRET: 'Required - JWT signing secret',
          ENCRYPTION_KEY: 'Required - Data encryption key',
          CORS_ORIGIN: 'Required - Frontend URL',
          NODE_ENV: 'Required - Environment',
          PORT: 'Required - Server port',
        };

        Object.keys(critical).forEach((key) => {
          // Check for both MONGODB_URI and MONGODB_URL
          const checkKey =
            key === 'MONGODB_URI' ? envVars['MONGODB_URI'] || envVars['MONGODB_URL'] : envVars[key];

          if (checkKey) {
            const status = checkKey.display.includes('NOT SET')
              ? '‚ùå MISSING'
              : checkKey.display.includes('AUTO-GENERATED')
                ? '‚úÖ AUTO-GENERATED'
                : '‚úÖ SET';
            console.log(`  ${status.padEnd(20)} ${key.padEnd(25)} ${critical[key]}`);
            if (key === 'MONGODB_URI' && envVars['MONGODB_URL']) {
              console.log(`  ‚ö†Ô∏è  NOTE: Variable is named MONGODB_URL (not MONGODB_URI)`);
            }
          } else {
            console.log(`  ‚ùå MISSING           ${key.padEnd(25)} ${critical[key]}`);
          }
        });

        console.log('');
        console.log('-'.repeat(80));
        console.log('');

        // Check important variables
        console.log('üìã IMPORTANT VARIABLES STATUS:');
        console.log('-'.repeat(80));

        const important = [
          'REDIS_HOST',
          'REDIS_URL',
          'FIREBASE_PRIVATE_KEY',
          'FIREBASE_CLIENT_EMAIL',
          'STORAGE_PROVIDER',
          'CLOUDINARY_CLOUD_NAME',
          'CLOUDINARY_API_KEY',
          'CLOUDINARY_API_SECRET',
          'STRIPE_SECRET_KEY',
          'GOOGLE_CLIENT_ID',
          'GOOGLE_CLIENT_SECRET',
        ];

        important.forEach((key) => {
          if (envVars[key]) {
            const status = envVars[key].display.includes('NOT SET') ? '‚ö†Ô∏è  MISSING' : '‚úÖ SET';
            console.log(`  ${status.padEnd(20)} ${key}`);
          } else {
            console.log(`  ‚ö†Ô∏è  MISSING          ${key}`);
          }
        });
      } else {
        console.log('Response format:', JSON.stringify(response.data, null, 2));
      }
    } else {
      console.log('Response:', JSON.stringify(response.data, null, 2));
    }

    console.log('');
    console.log('='.repeat(80));
  } catch (error) {
    console.error('‚ùå Error:', error.message);
  }
}

fetchEnvVars();

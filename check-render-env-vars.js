#!/usr/bin/env node

/**
 * Script to check which environment variables are configured in render.yaml
 * and which ones are needed based on backend code
 */

const fs = require('fs');
const path = require('path');

// Read render.yaml
const renderYamlPath = path.join(__dirname, RENDER_YAML);
const renderYaml = fs.readFileSync(renderYamlPath, 'utf8');

// Parse render.yaml to extract env vars
const envVarsInRender = {};
const envVarRegex = /- key: (\w+)\s+value: (.+)/g;
const generateValueRegex = /- key: (\w+)\s+generateValue: true/g;
const syncFalseRegex = /- key: (\w+)[\s\S]*?sync: false/g;

// Constants for repeated strings
const RENDER_YAML = 'render.yaml';
const DASH_LINE = '-'.repeat(80);
const DASH_LINE_SHORT = '-'.repeat(50);

let match;
while ((match = envVarRegex.exec(renderYaml)) !== null) {
  envVarsInRender[match[1]] = { value: match[2], source: RENDER_YAML };
}

while ((match = generateValueRegex.exec(renderYaml)) !== null) {
  envVarsInRender[match[1]] = { value: 'AUTO_GENERATED', source: RENDER_YAML };
}

// Read .env.example to get all possible variables
const envExamplePath = path.join(__dirname, 'backend', '.env.example');
const envExample = fs.readFileSync(envExamplePath, 'utf8');

// Parse .env.example
const allPossibleVars = {};
const envExampleRegex = /^([A-Z_]+)=(.+)$/gm;
while ((match = envExampleRegex.exec(envExample)) !== null) {
  allPossibleVars[match[1]] = match[2].trim();
}

// Critical variables that MUST be set (based on code analysis)
const criticalVars = {
  MONGODB_URI: 'Required - MongoDB connection string',
  JWT_SECRET: 'Required - JWT token signing secret',
  ENCRYPTION_KEY: 'Required - Data encryption key',
  CORS_ORIGIN: 'Required - Frontend URL for CORS',
  NODE_ENV: 'Required - Environment (production/development)',
  PORT: 'Required - Server port (auto-set by Render)',
};

// Important variables (app will work but features disabled)
const importantVars = {
  REDIS_HOST: 'Redis host (or use REDIS_URL)',
  REDIS_URL: 'Redis connection URL (alternative to REDIS_HOST)',
  FIREBASE_PROJECT_ID: 'Firebase project ID',
  FIREBASE_PRIVATE_KEY: 'Firebase private key',
  FIREBASE_CLIENT_EMAIL: 'Firebase client email',
  STORAGE_PROVIDER: 'Storage provider (s3 or cloudinary)',
  CLOUDINARY_CLOUD_NAME: 'Cloudinary cloud name',
  CLOUDINARY_API_KEY: 'Cloudinary API key',
  CLOUDINARY_API_SECRET: 'Cloudinary API secret',
  STRIPE_SECRET_KEY: 'Stripe secret key',
  GOOGLE_CLIENT_ID: 'Google OAuth client ID',
  GOOGLE_CLIENT_SECRET: 'Google OAuth client secret',
};

// Optional variables (nice to have)
const optionalVars = {
  OPENAI_API_KEY: 'OpenAI API key for AI features',
  TWILIO_ACCOUNT_SID: 'Twilio account SID',
  SENTRY_DSN: 'Sentry error tracking',
  SMTP_HOST: 'SMTP host for emails',
  EXPO_ACCESS_TOKEN: 'Expo push notifications',
};

console.log('='.repeat(80));
console.log('RENDER ENVIRONMENT VARIABLES ANALYSIS');
console.log('='.repeat(80));
console.log();

// Check what's in render.yaml
console.log('ðŸ“‹ VARIABLES IN render.yaml:');
console.log(DASH_LINE);
Object.keys(envVarsInRender).forEach((key) => {
  const config = envVarsInRender[key];
  if (config.value === 'AUTO_GENERATED') {
    console.log(`  âœ… ${key}: AUTO_GENERATED by Render`);
  } else {
    console.log(`  âœ… ${key}: ${config.value}`);
  }
});
console.log();

// Check critical variables
console.log('ðŸ”´ CRITICAL VARIABLES (MUST BE SET):');
console.log(DASH_LINE);
Object.keys(criticalVars).forEach((key) => {
  if (envVarsInRender[key]) {
    console.log(
      `  âœ… ${key}: ${envVarsInRender[key].value === 'AUTO_GENERATED' ? 'AUTO_GENERATED' : 'SET'}`
    );
  } else {
    console.log(`  âŒ ${key}: MISSING - ${criticalVars[key]}`);
  }
});
console.log();

// Check important variables
console.log('ðŸŸ¡ IMPORTANT VARIABLES (FEATURES MAY BE DISABLED IF MISSING):');
console.log(DASH_LINE);
Object.keys(importantVars).forEach((key) => {
  if (envVarsInRender[key]) {
    console.log(`  âœ… ${key}: SET`);
  } else {
    console.log(`  âš ï¸  ${key}: MISSING - ${importantVars[key]}`);
  }
});
console.log();

// Summary
console.log('ðŸ“Š SUMMARY:');
console.log(DASH_LINE);
const criticalMissing = Object.keys(criticalVars).filter((k) => !envVarsInRender[k]);
const importantMissing = Object.keys(importantVars).filter((k) => !envVarsInRender[k]);

console.log(`  Variables in render.yaml: ${Object.keys(envVarsInRender).length}`);
console.log(
  `  Critical variables set: ${Object.keys(criticalVars).length - criticalMissing.length}/${Object.keys(criticalVars).length}`
);
console.log(
  `  Important variables set: ${Object.keys(importantVars).length - importantMissing.length}/${Object.keys(importantVars).length}`
);
console.log();

if (criticalMissing.length > 0) {
  console.log('âš ï¸  ACTION REQUIRED:');
  console.log(DASH_LINE);
  console.log('  The following CRITICAL variables need to be set in Render Dashboard:');
  criticalMissing.forEach((key) => {
    console.log(`    - ${key}: ${criticalVars[key]}`);
  });
  console.log();
  console.log('  To set them:');
  console.log('    1. Go to https://dashboard.render.com');
  console.log('    2. Select your service: dating-app-backend');
  console.log('    3. Go to Environment tab');
  console.log('    4. Add the missing variables');
  console.log();
}

if (importantMissing.length > 0) {
  console.log('ðŸ’¡ RECOMMENDED:');
  console.log(DASH_LINE);
  console.log('  Consider setting these important variables for full functionality:');
  importantMissing.slice(0, 5).forEach((key) => {
    console.log(`    - ${key}: ${importantVars[key]}`);
  });
  if (importantMissing.length > 5) {
    console.log(`    ... and ${importantMissing.length - 5} more`);
  }
  console.log();
}

console.log('='.repeat(80));
console.log('Note: Render CLI cannot directly list environment variables for security reasons.');
console.log('      You need to check them in the Render Dashboard or set them via CLI.');
console.log('='.repeat(80));

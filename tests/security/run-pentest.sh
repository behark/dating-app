#!/bin/bash

# OWASP ZAP Penetration Testing Script
# Runs automated security scans against the dating app

set -e

# Configuration
API_URL="${API_URL:-http://localhost:3001}"
WEB_URL="${WEB_URL:-http://localhost:19006}"
ZAP_PORT="${ZAP_PORT:-8090}"
REPORTS_DIR="./tests/security/reports"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=============================================="
echo "  OWASP ZAP Security Penetration Testing"
echo "=============================================="
echo ""

# Create reports directory
mkdir -p "$REPORTS_DIR"

# Function to run baseline scan
run_baseline_scan() {
    echo -e "${YELLOW}Running Baseline Scan...${NC}"
    
    docker run --rm \
        -v "$(pwd)/$REPORTS_DIR:/zap/wrk:rw" \
        --network host \
        zaproxy/zap-stable zap-baseline.py \
        -t "$API_URL" \
        -r baseline-report.html \
        -J baseline-report.json \
        -I

    echo -e "${GREEN}Baseline scan complete!${NC}"
}

# Function to run API scan
run_api_scan() {
    echo -e "${YELLOW}Running API Scan...${NC}"
    
    # Check if OpenAPI spec exists
    if [ -f "./backend/openapi.yaml" ]; then
        docker run --rm \
            -v "$(pwd)/$REPORTS_DIR:/zap/wrk:rw" \
            -v "$(pwd)/backend/openapi.yaml:/zap/openapi.yaml:ro" \
            --network host \
            zaproxy/zap-stable zap-api-scan.py \
            -t "$API_URL" \
            -f openapi \
            -O /zap/openapi.yaml \
            -r api-report.html \
            -J api-report.json \
            -I
    else
        echo "OpenAPI spec not found, running without spec..."
        docker run --rm \
            -v "$(pwd)/$REPORTS_DIR:/zap/wrk:rw" \
            --network host \
            zaproxy/zap-stable zap-api-scan.py \
            -t "$API_URL" \
            -f openapi \
            -r api-report.html \
            -J api-report.json \
            -I
    fi

    echo -e "${GREEN}API scan complete!${NC}"
}

# Function to run full scan
run_full_scan() {
    echo -e "${YELLOW}Running Full Scan (this may take a while)...${NC}"
    
    docker run --rm \
        -v "$(pwd)/$REPORTS_DIR:/zap/wrk:rw" \
        --network host \
        zaproxy/zap-stable zap-full-scan.py \
        -t "$WEB_URL" \
        -r full-report.html \
        -J full-report.json \
        -I \
        -m 30

    echo -e "${GREEN}Full scan complete!${NC}"
}

# Function to run custom automation
run_custom_scan() {
    echo -e "${YELLOW}Running Custom Automation Scan...${NC}"
    
    docker run --rm \
        -v "$(pwd)/tests/security:/zap/config:ro" \
        -v "$(pwd)/$REPORTS_DIR:/reports:rw" \
        --network host \
        zaproxy/zap-stable \
        zap.sh -cmd -autorun /zap/config/zap-config.yaml

    echo -e "${GREEN}Custom scan complete!${NC}"
}

# Function to analyze results
analyze_results() {
    echo ""
    echo -e "${YELLOW}Analyzing Results...${NC}"
    echo "=============================================="
    
    # Check for high-risk alerts
    if [ -f "$REPORTS_DIR/baseline-report.json" ]; then
        HIGH_ALERTS=$(jq '.site[0].alerts | map(select(.riskcode == "3")) | length' "$REPORTS_DIR/baseline-report.json" 2>/dev/null || echo "0")
        MEDIUM_ALERTS=$(jq '.site[0].alerts | map(select(.riskcode == "2")) | length' "$REPORTS_DIR/baseline-report.json" 2>/dev/null || echo "0")
        LOW_ALERTS=$(jq '.site[0].alerts | map(select(.riskcode == "1")) | length' "$REPORTS_DIR/baseline-report.json" 2>/dev/null || echo "0")
        
        echo "Baseline Scan Results:"
        echo -e "  ${RED}High Risk: $HIGH_ALERTS${NC}"
        echo -e "  ${YELLOW}Medium Risk: $MEDIUM_ALERTS${NC}"
        echo -e "  Low Risk: $LOW_ALERTS"
    fi
    
    echo ""
    echo "Reports saved to: $REPORTS_DIR"
    echo "=============================================="
}

# Parse command line arguments
SCAN_TYPE="${1:-baseline}"

case $SCAN_TYPE in
    baseline)
        run_baseline_scan
        ;;
    api)
        run_api_scan
        ;;
    full)
        run_full_scan
        ;;
    custom)
        run_custom_scan
        ;;
    all)
        run_baseline_scan
        run_api_scan
        run_full_scan
        ;;
    *)
        echo "Usage: $0 [baseline|api|full|custom|all]"
        echo ""
        echo "  baseline - Quick passive scan (recommended for CI/CD)"
        echo "  api      - API-focused scan"
        echo "  full     - Comprehensive active scan (takes longer)"
        echo "  custom   - Run custom automation config"
        echo "  all      - Run all scan types"
        exit 1
        ;;
esac

analyze_results

# Exit with error if high-risk vulnerabilities found
if [ "$HIGH_ALERTS" -gt "0" ]; then
    echo -e "${RED}FAILED: High-risk vulnerabilities detected!${NC}"
    exit 1
fi

echo -e "${GREEN}Security scan completed successfully!${NC}"
